# Structure from Motion (SfM) 과제 완벽 가이드 (쉬운 한글 설명)

이 문서는 여러 장의 사진으로 3D 장면을 만들어내는 **Structure from Motion (SfM)** 과제를 쉽게 이해하고 실행할 수 있도록 정리한 가이드입니다. 이미 정답 코드는 파일에 모두 적용해 두었으니, 이 문서를 읽고 흐름만 이해하시면 됩니다.

## 1. SfM이 뭔가요? (핵심 개념)

SfM은 **2D 사진 여러 장을 보고, 카메라가 어디 있었는지(M: Motion)와 찍힌 물체들의 3D 모양(S: Structure)을 동시에 알아내는 기술**입니다.

우리가 한쪽 눈을 감고 물체를 보면 거리감을 알기 어렵지만, 두 눈(양안)으로 보거나 이동하면서 보면 입체감을 알 수 있는 원리와 같습니다.

### 전체 4단계 과정 요약

1.  **특징 찾기 & 짝짓기 (`feature.py`)**  
    물체에 있는 점(특징점)들을 찾고, "A 사진의 이 점이 B 사진의 저 점이랑 같은 거야!" 라고 짝을 지어줍니다.
2.  **초기 뼈대 만들기 (`camera_pose.py`)**  
    가장 처음 두 장의 사진을 이용해 대략적인 3D 공간을 만듭니다. 두 카메라 사이의 거리와 각도를 계산하고(Essential Matrix), 점들의 3D 좌표를 계산합니다(Triangulation).
3.  **살 붙이기 (`pnp.py`)**  
    이미 만들어진 3D 점들을 힌트로 삼아, 세 번째, 네 번째... 새로운 사진 속 카메라가 어디에 있는지 알아냅니다. 이걸 **PnP**라고 부릅니다.
4.  **다듬기 (`reconstruction.py`)**  
    계산하다 보면 오차가 생깁니다. 모든 카메라 위치와 3D 점들을 조금씩 움직여서, 실제 사진과 딱 맞도록 최적화합니다. 이걸 **Bundle Adjustment(BA)**라고 합니다.

---

## 2. 파일별 역할 설명

| 파일명 | 역할 (비유) | 구현 내용 |
| :--- | :--- | :--- |
| **`feature.py`** | **탐정** | 사진 속에서 눈에 띄는 점(SIFT)을 찾고, 다른 사진에서 같은 점을 찾아냅니다. |
| **`camera_pose.py`** | **건축가 (기초)** | 첫 두 장의 사진으로 건물의 기초(첫 카메라 위치와 3D 점)를 세웁니다. |
| **`pnp.py`** | **측량사** | 이미 있는 3D 점들을 보고 "아, 내가 이쯤에서 찍고 있구나" 하고 새 카메라 위치를 찾습니다. |
| **`reconstruction.py`** | **리모델링 전문가** | 전체적으로 틀어진 부분이 없는지 정밀하게 검사하고 수정(최적화)합니다. |
| **`utils.py`** | **공구함** | 회전 행렬을 쿼터니언으로 바꾸는 등 계산 도구들이 들어있습니다. |
| **`hw4.py`** | **현장 감독** | 위 전문가들에게 순서대로 일을 시키고 최종 결과물을 만들어냅니다. |

---

## 3. 실행 방법

모든 정답 코드는 이미 작성하여 파일에 저장해 두었습니다. 이제 실행만 하시면 됩니다.

### 터미널에서 실행하기

1.  터미널을 엽니다.
2.  과제 폴더로 이동합니다.
    ```bash
    cd /Users/joon/dev/MVG/2_hw4_SfM
    ```
3.  프로그램을 실행합니다.
    ```bash
    python hw4.py
    ```

### 결과 확인

실행이 끝나면 `output` 폴더에 결과 파일들이 생깁니다.
-   `points_X.ply`: X번째 단계까지 복원된 **3D 점 구름 (Point Cloud)**
-   `cameras_X.ply`: X번째 단계의 **카메라 위치들**

이 파일들은 **MeshLab**이나 **Open3D** 같은 3D 뷰어 프로그램으로 열어서 볼 수 있습니다.

---

## 4. 자주 묻는 질문 (FAQ)

**Q: 왜 Cheirality Check라는 걸 하나요?**  
A: 수학적으로는 카메라가 물체 '앞'에 있을 수도 있고 '뒤'에 있을 수도 있는 4가지 경우가 나옵니다. 하지만 현실에서 카메라는 항상 물체 '앞'을 찍죠. 그래서 "점이 카메라 앞에 있는가?"를 확인해서 진짜 정답 1개를 고르는 과정입니다.

**Q: Bundle Adjustment는 왜 필요한가요?**  
A: 처음 계산 값들은 조금씩 오차가 있습니다. 사진을 더할수록 이 오차가 점점 커져서 나중에는 엉뚱한 모양이 될 수 있습니다. 그래서 중간중간 "잠깐, 다 같이 맞춰보자" 하면서 전체적으로 조금씩 수정해주는 과정이 꼭 필요합니다.
